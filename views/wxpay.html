<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link href="/public/img/wxpay.png" rel="shortcut icon">
    <meta http-equiv="Content-Language" content="zh-cn">
    <meta name="apple-mobile-web-app-capable" content="no"/>
    <meta name="apple-touch-fullscreen" content="yes"/>
    <meta name="format-detection" content="telephone=no,email=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
 
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>微信支付</title>
    <link href="/public/css/gateway.css" rel="stylesheet" media="screen">
    <script src="/public/js/jquery.min.js"></script>
</head>

<body>
<div class="body">
    <h1 class="mod-title">
        <span class="ico_log ico-wxpay"></span>
    </h1>

    <div class="mod-ct">
        <div class="order">
        </div>
        <div class="amount" id="money">{{ money }}&nbsp;元</div>
		<div id="random_price" style="color:red;font-size:20px;margin-bottom:8px;"></div>
        <div class="qrcode-img-wrapper" data-role="qrPayImgWrapper">
            <div data-role="qrPayImg" class="qrcode-img-area">
                <div class="ui-loading qrcode-loading" data-role="qrPayImgLoading" ></div>
                <div style="position: relative;display: inline-block;">
                    <img id="qrcode" style="width:208px;height:208px;" src="http://logpay.paywz.cn/qrcode/image?text={{codeUrl}}">
                    <img id="pay_ok" style="display:none;">
                    <img id="outTime" style="display:none;">						
				   <!-- <button style="width:100px;height:50px;background-color:#67C23A;color:#fff;border-radius:5px;display:block;margin:0 auto;">保存二维码</button>-->
                    <div id="orderNumber" style="display: none;">{{ orderNumber }}</div>
                    <div id="expire" style="display: none;">{{ expire }}</div>
                    <div id="uid" style="display: none;">{{ uid }}</div>
					<div id="price" style="display:none">{{ price }}</div>
					<div id="pay_price" style="display:none">{{ pay_price }}</div>
					<!--<div id="codeUrl" style="display: none;">{{ codeUrl }}</div>-->
                </div>
        </div>
        <div class="time-item" style = "padding-top: 10px">
<script type="text/javascript">
//      let codeUrl = 'http://logpay.paywz.cn/qrcode/image?text=' + $('#codeUrl').html()
//	  $("button").click(function(){
//})
//	  $("buttondd").click(function(){
//	    function downloadIamge(imgsrc, name) {//下载图片地址和图片名
//        let image = new Image()
//       // 解决跨域 Canvas 污染问题
//      image.setAttribute("crossOrigin", "anonymous")
//       image.onload = function() {
//           let canvas = document.createElement("canvas")
//          canvas.width = image.width
//            canvas.height = image.height
//            let context = canvas.getContext("2d")
//            context.drawImage(image, 0, 0, image.width, image.height)
//            let url = canvas.toDataURL("image/png") //得到图片的base64编码数据
//            let a = document.createElement("a") // 生成一个a元素
//           let event = new MouseEvent("click") // 创建一个单击事件
//            a.download = name || "photo" // 设置图片名称
//            a.href = url // 将生成的URL设置为a.href属性
//            a.dispatchEvent(event) // 触发a的单击事件
//       }
//       image.src = imgsrc
//       }
//        function downs(){
//          downloadIamge( codeUrl, codeUrl + '.png')
//        }
//	    downs()
//      })
     var expires_in = $('#expire').html()
            var do_expire = function (h) {
                clearInterval(h)
                $("#count_down").html("订单已过期")
                $("#qrcode").attr("src","data:image/png;base64,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")
            }

    var handler = setInterval(function () {
                expires_in--
                if(expires_in <= 0) {
                    do_expire(handler)
                } else {
                    var min = parseInt(expires_in / 60)
                    $("#count_down").html( (min?(min+ " 分 "):"") + expires_in % 60 + " 秒后订单过期，请及时支付" )
                }
            }, 1000)
    var orderNumber = $('#orderNumber').html()
    var uid = $('#uid').html()
	var price = $('#price').html()
	var pay_price = $('#pay_price').html()
	var random_price = (parseFloat(price) - parseFloat(pay_price)).toFixed(2,'0')
	if ( parseFloat(random_price) !== 0.00 ) {
	    $('#random_price').html('随机立减 ' + parseFloat(random_price).toFixed(2,'0') + ' 元')
	}
    var myTimer = window.setInterval(function () {
        checkOrder()
    },1000)
    function checkOrder() {
        $.post(
            "/server/api/query",
            {
                orderNumber:orderNumber,
                uid:uid
            },
             function (data) {
                 if (data.code > 1) {
                     $("#qrcode").attr("src", "/public/img/pay_ok.png")
                     $('#orderNumber').remove()
                     window.clearInterval(myTimer)
                     $("#money").text("支付成功")
                     $("#msg").html("<h1>即将返回商家页</h1>")
                     $("#msg").html("<h1>即将<a href= " + data.url + ">跳转</a>回商家页</h1>")
                     setTimeout(function () {
                         window.location = data.url
                     }, 500);
                 }
             }
        )
    }
</script>

                 <!--手机支付-->
<p style="color:red; font-size: 20px; " id="count_down"></p>
<div class="time-item" id="msg"><h1><h1>支付完成后，自动跳转商户页面</h1></div>
<div class="time-item"><h1>订单:{{ orderNumber }}</h1></div>
        </div>
        <div class="tip">
            <div class="ico-scan"></div>
            <div class="tip-text"><!--在PC里-->
                    <p id="showtext">打开微信 [扫一扫]</p>
            </div>
        </div>
        <div class="tip-text"></div>
    </div>
    <div class="foot">
        <div class="inner">
            <p>手机用户可保存上方二维码到手机中</p>
            <p>在微信扫一扫中选择“相册”即可</p>
            <p></p>
        </div>
    </div>
    </div>
</body>
</html>