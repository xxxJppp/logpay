<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link href="/public/img/wxpay.png" rel="shortcut icon">
    <meta http-equiv="Content-Language" content="zh-cn">
    <meta name="apple-touch-fullscreen" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=yes" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge，chrome=1">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <title>微信支付</title>
    <link href="/public/css/gateway.css" rel="stylesheet" media="screen">
    <script src="/public/js/jquery.min.js"></script>
</head>

<body>
<div class="body">
    <h1 class="mod-title">
        <span class="ico_log ico-wxpay"></span>
    </h1>
    <div class="mod-ct">
        <div class="order"></div>
        <div class="amount" id="money" style="font-size:25px;color:#67C23A;">{{ money }}&nbsp;元</div>
		<div id="random_price" style="color:red;font-size:20px;margin-bottom:8px;"></div>
        <div class="qrcode-img-wrapper" data-role="qrPayImgWrapper">
            <div data-role="qrPayImg" class="qrcode-img-area" id="contbox">
                <div class="ui-loading qrcode-loading" data-role="qrPayImgLoading" ></div>
                <div style="position: relative;display: inline-block;">
                    <img id="qrcode" style="width:208px;height:208px;" src="https://api.logpay.cn/qrcode/image?text={{codeUrl}}">
                    <div id="phonePay">
					<p>1.截图保存本页面</p>
					<a id="weixin" href=""
					<button style="
                        width: 300px;
                        background-color:#67C23A;
                        border-radius:5px;
                        margin:2px auto;"
                        class="btn btn-primary">
                        2.打开微信扫一扫->本地照片->刚保存的页面
                    </button>
					</a>
				    <p>3.付款</p>
					</div>
                </div>
            </div>
        </div>    
        <div class="time-item" style = "padding-top: 10px">
            <p style="color:red; font-size: 20px; " id="count_down"></p>
            <div class="time-item" id="msg"><h1><h1>支付完成后，自动跳转商户页面</h1></div>
            <div class="time-item"><h1>订单:{{ orderNumber }}</h1></div>
        </div>

        <div class="tip">
            <div id="pc" style="display:none;">
                <div class="ico-scan"></div>
                <div  class="tip-text">
                    <p id="showtext ico-scan">打开微信 [扫一扫]</p>
                </div>
				<!--<p style="font-size:22px;color:red;margin-top:10px;">请付款 <span style="font-size:20px;color:green;">{{ pay_price }}</span> 元 注意不要多付或者少付 防止充值不到帐</p>-->
            </div>
            <div id="phone" class="foot" style="display:none;">
                <div class="inner" >
                    <p style="font-size:22px;">请付款 <span style="font-size:20px;color:green;">{{ pay_price }}</span> 元 注意不要多付或者少付</p>
                </div>
            </div>
        </div>

    </div>
    <div id="orderNumber" style="display: none;">{{ orderNumber }}</div>
    <div id="expire" style="display: none;">{{ expire }}</div>
    <div id="uid" style="display: none;">{{ uid }}</div>
    <div id="price" style="display:none">{{ price }}</div>
    <div id="pay_price" style="display:none">{{ pay_price }}</div>
</div>
<script type="text/javascript">
    $(document).ready(function(){
        if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) {
            $('#phonePay').css('display','block')
            $('#phone').css('display','inline')
	        $('#weixin').attr("href", "weixin://scanqrcode")

        } else if (/(Android)/i.test(navigator.userAgent)){
            $('#phonePay').css('display','block')
            $('#phone').css('display','inline')
		    $('#weixin').attr("href", "weixin://")

        } else {
		$('#phonePay').css('display','none')
        $('#pc').css('display','inline')
		}
//       $.get('/qrcode/codeBase64?text=' + $('#codeUrl').html(),function(data){
//          $("#qrcode").attr("src",'data:image/png;base64,' + data)
//        })
     })
     var expires_in = $('#expire').html()
            var do_expire = function (h) {
                clearInterval(h)
                $("#count_down").html("订单已过期")
                $("#qrcode").attr("src","data:image/png;base64,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")
			}

    var handler = setInterval(function () {
                expires_in--
                if(expires_in <= 0) {
                    do_expire(handler)
                } else {
                    var min = parseInt(expires_in / 60)
                    $("#count_down").html( (min?(min+ " 分 "):"") + expires_in % 60 + " 秒后订单过期，请及时支付" )
                }
            }, 1000)
    var orderNumber = $('#orderNumber').html()
    var uid = $('#uid').html()
	var price = $('#price').html()
	var pay_price = $('#pay_price').html()
	var random_price = (parseFloat(price) - parseFloat(pay_price)).toFixed(2,'0')
	if ( parseFloat(random_price) !== 0.00 ) {
	    $('#random_price').html('随机立减 ' + parseFloat(random_price).toFixed(2,'0') + ' 元')
	}
    var myTimer = window.setInterval(function () {
        checkOrder()
    },1000)
    function checkOrder() {
        $.post(
            "/server/api/query",
            {
                orderNumber:orderNumber,
                uid:uid
            },
             function (data) {
                 if (data.code > 1) {
                     $("#qrcode").attr("src", "/public/img/pay_ok.png")
                     $('#orderNumber').remove()
                     window.clearInterval(myTimer)
                     $("#money").text("支付成功")
                     $("#msg").html("<h1>即将返回商家页</h1>")
                     $("#msg").html("<h1>即将<a href= " + data.url + ">跳转</a>回商家页</h1>")
                     setTimeout(function () {
                         window.location = data.url
                     }, 500);
                 }
             }
        )
    }
</script>
</body>
</html>